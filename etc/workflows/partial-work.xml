<?xml version="1.0" encoding="UTF-8"?>
<definition xmlns="http://workflow.opencastproject.org">

  <id>partial-work</id>
  <title>Prepare work versions</title>
  <tags/>
  <description/>

  <configuration_panel></configuration_panel>

  <operations>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Prepare the work media                                            -->
    <!--                                                                   -->
    <!-- Ensure the work media is in a format that allows Opencast to do   -->
    <!-- its work. This includes potentially rewriting the container and   -->
    <!-- making sure that the audio track is part of each video track.     -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <!-- Prepare presenter track -->

    <operation
      id="prepare-av"
      exception-handler-workflow="partial-error"
      description="Preparing presenter (camera) audio and video work versions">
      <configurations>
        <configuration key="source-flavor">presenter/source</configuration>
        <configuration key="target-flavor">presenter/prepared</configuration>
        <configuration key="target-tags">-archive</configuration>
        <configuration key="rewrite">false</configuration>
        <configuration key="audio-muxing-source-flavors">*/?,*/*</configuration>
      </configurations>
    </operation>

    <!-- Prepare presentation track -->

    <operation
      id="prepare-av"
      exception-handler-workflow="partial-error"
      description="Preparing presentation (screen) audio and video work version">
      <configurations>
        <configuration key="source-flavor">presentation/source</configuration>
        <configuration key="target-flavor">presentation/prepared</configuration>
        <configuration key="target-tags">-archive</configuration>
        <configuration key="rewrite">false</configuration>
        <configuration key="audio-muxing-source-flavors">*/?,*/*</configuration>
      </configurations>
    </operation>


    <!-- Hide/mute video/audio streams as selected by the user -->
    <operation
        id="compose"
        description="Strip video stream from presenter if video should be hidden"
        if="${presenter_video_hidden}"
        exception-handler-workflow="partial-error">
      <configurations>
        <configuration key="source-flavor">presenter/prepared</configuration>
        <configuration key="target-flavor">presenter/prework</configuration>
        <configuration key="encoding-profile">audio-only.work</configuration>
      </configurations>
    </operation>
    <operation
        id="compose"
        description="Strip video stream from presentation if video should be hidden"
        if="${presentation_video_hidden}"
        exception-handler-workflow="partial-error">
      <configurations>
        <configuration key="source-flavor">presentation/prepared</configuration>
        <configuration key="target-flavor">presentation/prework</configuration>
        <configuration key="encoding-profile">audio-only.work</configuration>
      </configurations>
    </operation>
    <operation
        id="compose"
        description="Strip audio stream from presenter if audio should be muted"
        if="${presenter_audio_hidden}"
        exception-handler-workflow="partial-error">
      <configurations>
        <configuration key="source-flavor">presenter/prepared</configuration>
        <configuration key="target-flavor">presenter/prework</configuration>
        <configuration key="encoding-profile">video-only.work</configuration>
      </configurations>
    </operation>
    <operation
        id="compose"
        description="Strip audio stream from presentation if audio should be muted"
        if="${presentation_audio_hidden}"
        exception-handler-workflow="partial-error">
      <configurations>
        <configuration key="source-flavor">presentation/prepared</configuration>
        <configuration key="target-flavor">presentation/prework</configuration>
        <configuration key="encoding-profile">video-only.work</configuration>
      </configurations>
    </operation>
    <operation
      id="tag"
      if="${presenter_video_hidden} AND NOT (${presenter_audio_hidden}) AND NOT(${presentation_video_hidden}) AND ${presentation_audio_hidden}"
      description="Prepare for muxing presenter audio with presentation video"
      exception-handler-workflow="partial-error">
      <configurations>
        <configuration key="source-flavors">*/prework</configuration>
        <configuration key="target-flavor">presentation/premux</configuration>
        <configuration key="copy">false</configuration>
      </configurations>
    </operation>
    <operation
      id="tag"
      if="NOT (${presenter_video_hidden}) AND ${presenter_audio_hidden} AND ${presentation_video_hidden} AND NOT (${presentation_audio_hidden})"
      description="Prepare for muxing presentation audio with presenter video"
      exception-handler-workflow="partial-error">
      <configurations>
        <configuration key="source-flavors">*/prework</configuration>
        <configuration key="target-flavor">presenter/premux</configuration>
        <configuration key="copy">false</configuration>
      </configurations>
    </operation>
    <operation
      id="prepare-av"
      description="Mux audio and video of two tracks into one"
      exception-handler-workflow="partial-error">
      <configurations>
        <configuration key="source-flavor">*/premux</configuration>
        <configuration key="target-flavor">*/work</configuration>
        <configuration key="rewrite">false</configuration>
      </configurations>
    </operation>

    <!-- Make sure tracks are correctly flavored in case no video/audio is hidden/muted -->

    <operation
      id="tag"
      if="NOT (${presenter_video_hidden}) AND NOT (${presenter_audio_hidden}))"
      description="Change flavor of prepared tracks to */work if no audio/video is hidden (default behavior)"
      exception-handler-workflow="partial-error">
      <configurations>
        <configuration key="source-flavors">presenter/prepared</configuration>
        <configuration key="target-flavor">presenter/work</configuration>
        <configuration key="copy">false</configuration>
      </configurations>
    </operation>
    <operation
      id="tag"
      if="NOT(${presentation_video_hidden}) AND NOT(${presentation_audio_hidden})"
      description="Change flavor of prepared tracks to */work if no audio/video is hidden (default behavior)"
      exception-handler-workflow="partial-error">
      <configurations>
        <configuration key="source-flavors">presentation/prepared</configuration>
        <configuration key="target-flavor">presentation/work</configuration>
        <configuration key="copy">false</configuration>
      </configurations>
    </operation>

  </operations>

</definition>
